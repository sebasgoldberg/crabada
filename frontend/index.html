<html>

<head>
    <script src="jquery-3.6.0.min.js"></script>
    <script src="gt4.js"></script>
</head>

<body>
    <div id="status"></div>
    <h2 id="result"></h2>
    <div id="captcha"></div>
    <script>

        const CAPTCHA_ID = 'a9cd95e65fc75072dadea93e3d60b0e6'

        const params = new Proxy(new URLSearchParams(window.location.search), {
            get: (searchParams, prop) => searchParams.get(prop),
        });

        function uuidv4() {
            return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        function getTransactionAndSendIt(captchaResult, gameId, looterAddress, looterTeamId){

            $.ajax({
                url: '/captcha/verify/',
                method: 'POST',
                data: JSON.stringify({
                    requester: params.requester,
                    game_id: gameId,
                    user_address: looterAddress, // OK
                    team_id: looterTeamId, // OK
                    lot_number: captchaResult.lot_number, // OK(2.response.lot_number)
                    pass_token: captchaResult.pass_token, // OK(2.response.pass_token)
                    gen_time: captchaResult.gen_time, // OK(2.response.gen_time)
                    captcha_output: captchaResult.captcha_output, // OK(2.response.captcha_output)
                }),
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log(data);
                    setTimeout(()=>{ location.reload(); }, 1500)
                    $('#result').text('GANASTE!!! ðŸ¤‘')
                },
                error: function (error){
                    console.error(error);
                    setTimeout(()=>{ location.reload(); }, 1500)
                    $('#result').text('SEGUI PARTICIPANDO... ðŸ˜’')
                }
            })

        }

        function loadCaptcha(timestamp, gameId, looterAddress, looterTeamId) {

            initGeetest4({
                captchaId: CAPTCHA_ID,
                product: "popup",
                // TODO Verify if uuidv4() it is the same than window.uuid()
                challenge: "".concat(timestamp).concat(gameId).concat(uuidv4()),
                // riskType
                riskType: "icon"
            }, function (captcha) {

                captcha.appendTo("#captcha");// call appendTo to insert the verification code into a certain element of the page, which can be customized by the user 

                captcha.onReady(function () {

                    var clickInterval = setInterval(() => {
                        $('.geetest_btn_click').click()
                    }, 500)

                    setTimeout(() => {
                        clearInterval(clickInterval)
                    }, 3000)


                }).onSuccess(function () {

                    // result example: { 
                    //     captcha_id: 'a9cd95e65fc75072dadea93e3d60b0e6', 
                    //     lot_number: '3b6f610d3b67402eacbef12940fd619b', 
                    //     pass_token: '70c3a7c2d0fe21e839d4d002c3ba3f4e096d438c4504ad7f6fdfd895d7e8258d', 
                    //     gen_time: '1646770092', 
                    //     captcha_output: 'zrZmJMfbTd-SNVauvuKQVK6UmwrNAghPXTqYynEOKtgTvJ65uMâ€¦ufocnxEM4K4WTf2j9RdcrzGGIW2YU9yCB6ccEzpSTyH13UA==' 
                    // }
                    var captchaResult = captcha.getValidate();

                    console.log(captchaResult);

                    // TODO set looter address and looter team ID.
                    getTransactionAndSendIt(captchaResult, gameId, looterAddress, looterTeamId)

                }).onError(function () {

                    alert('ERROR')

                })


            });

        }

        $.ajax({
                url: '/captcha/load/',
                method: 'POST',
                data: JSON.stringify({
                    requester: params.requester || 'no-identity',
                }),
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    console.log(data);
                    loadCaptcha(+new Date(), data.game_id, data.user_address, data.team_id)
                },
                error: function (error){
                    console.error(error);
                }
        })

        $.ajax({
                url: '/status/',
                method: 'GET',
                data: JSON.stringify({
                    requester: params.requester || 'no-identity',
                }),
                dataType: 'json',
                contentType: "application/json; charset=utf-8",
                success: function (data) {
                    $('#status').text(JSON.stringify(data))
                },
                error: function (error){
                    console.error(error);
                }
        })

    </script>
</body>

</html>